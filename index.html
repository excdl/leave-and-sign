<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è«‹å‡ç°½æ ¸ç³»çµ±</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; margin:0; padding:0; }

/* ç™»å…¥å¡ç‰‡ */
#loginBox {
  display:flex; flex-direction:column;
  max-width:400px; margin:80px auto;
  background:#fff; padding:30px; border-radius:12px;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);
}
#loginBox h2 { margin:0 0 20px 0; font-size:1.8em; text-align:center; }
#loginBox input {
  padding:12px; margin:8px 0; font-size:1.1em; border-radius:6px; border:1px solid #ccc;
  width:100%; box-sizing:border-box;
}
#loginBox button {
  padding:12px; margin-top:12px; font-size:1.1em; border:none; border-radius:6px;
  background:#1976d2; color:#fff; cursor:pointer; width:100%;
  transition:0.3s;
}
#loginBox button:hover { background:#1565c0; }

/* ä¸»å¡ç‰‡ */
#mainCard { display:none; margin:15px; }
#mainCard h2 {
  font-size:1.6em;
  margin-bottom:10px;
  display:flex; justify-content:space-between; align-items:center;
}
#mainCard button.logoutBtn {
  background:#d32f2f; color:#fff; border:none; padding:6px 12px; border-radius:6px;
  cursor:pointer; font-weight:bold; font-size:0.7em;
  transition:0.3s;
}
#mainCard button.logoutBtn:hover { background:#b71c1c; }

/* Tabs */
.filters {
  display:flex; overflow-x:auto; margin:10px 0;
  -webkit-overflow-scrolling:touch; scroll-behavior:smooth;
}
.filters button {
  flex:0 0 auto; margin-right:10px; padding:10px 20px; border:none; border-radius:20px;
  font-size:1em; font-weight:bold; background:#e0e0e0; cursor:pointer; white-space:nowrap; transition:0.3s;
}
.filters button.active { background:#1976d2; color:#fff; transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.2); }

/* è¡¨æ ¼ */
table { width:100%; border-collapse:collapse; margin-top:10px; font-size:1.2em; }
th, td { padding:8px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#1976d2; color:#fff; position:sticky; top:0; }
tr:hover { background:#f1f1f1; cursor:pointer; }

/* æ¨™ç±¤å¾½ç«  */
.badge { display:inline-block; padding:4px 12px; border-radius:12px; color:#fff; font-weight:bold; cursor:pointer; }
.badge-æœªç°½æ ¸ { background:#d32f2f; }
.badge-ç°½æ ¸ä¸­ { background:#f57c00; }
.badge-å·²ç°½æ ¸ { background:#388e3c; }

/* Modal */
#overlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.4);
  z-index:999;
}
#modal {
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:90%; max-width:400px;
  font-size:1em;
  z-index:1000;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
#modal h3 { margin-top:0; font-size:1.4em; }
#modal .closeBtn {
  position:absolute; top:10px; right:10px;
  background:#d32f2f; color:#fff; border:none; border-radius:50%;
  width:32px; height:32px; font-size:1.2em; cursor:pointer; line-height:32px; text-align:center;
}
#modal .actionBtns { display:flex; justify-content:space-between; margin-top:20px; }
#modal button.approveBtn, #modal button.rejectBtn {
  flex:1; margin:0 5px; padding:10px 0; border:none; border-radius:8px;
  font-size:0.935em; cursor:pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; color:#fff;
}
#modal button.approveBtn { background:#388e3c; }
#modal button.rejectBtn { background:#d32f2f; }
#modal button.approveBtn:active, #modal button.rejectBtn:active { transform:scale(0.95); box-shadow:0 2px 6px rgba(0,0,0,0.2); }

/* å°è¢å¹•è‡ªé©æ‡‰ */
@media (max-width:600px) {
  table { font-size:1em; }
  th, td { padding:6px; }
  .filters button { font-size:0.9em; padding:8px 16px; }
}
</style>
</head>
<body>

<div class="card" id="loginBox">
  <h2>è«‹å‡ç°½æ ¸ç³»çµ±</h2>
  <input id="loginCode" type="password" placeholder="è«‹è¼¸å…¥ä»£ç¢¼">
  <button onclick="login()">ç™»å…¥</button>
</div>

<div class="card" id="mainCard">
  <h2>
    è«‹å‡ç°½æ ¸ç³»çµ±
    <button class="logoutBtn" onclick="logout()">ç™»å‡º</button>
  </h2>

  <div class="filters">
    <button id="btnAll" onclick="setStatus('ALL')">å…¨éƒ¨</button>
    <button id="btnPending" onclick="setStatus('æœªç°½æ ¸')">æœªç°½æ ¸</button>
    <button id="btnProcessing" onclick="setStatus('ç°½æ ¸ä¸­')">ç°½æ ¸ä¸­</button>
    <button id="btnDone" onclick="setStatus('å·²ç°½æ ¸')">å·²ç°½æ ¸</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ç”³è«‹æ—¥</th>
        <th>å§“å</th>
        <th>å‡åˆ¥</th>
        <th>èµ·å§‹</th>
        <th>çµ‚æ­¢</th>
        <th>æ™‚æ•¸</th>
        <th>ç‹€æ…‹</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="overlay"></div>
<div id="modal">
  <button class="closeBtn" onclick="closeModal()">Ã—</button>
  <h3>ç°½æ ¸</h3>
  <div>å§“åï¼š<span id="modalName"></span></div>
  <div>å‡åˆ¥ï¼š<span id="modalType"></span></div>
  <div>èµ·å§‹ï¼š<span id="modalStart"></span></div>
  <div>çµ‚æ­¢ï¼š<span id="modalEnd"></span></div>
  <div>æ™‚æ•¸ï¼š<span id="modalHours"></span></div>
  <div>äº‹ç”±ï¼š<span id="modalReason"></span></div>
  <div class="actionBtns">
    <button class="approveBtn" onclick="submit(true)">æ ¸å‡†</button>
    <button class="rejectBtn" onclick="submit(false)">ä¸å‡†</button>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS8VE_tdpSWDqD9Vc_-O-x7wqhswJeij9RWaHfI1UN-fyjPG4aeMnZHfGWoraSvFrmsA/exec'; // æ”¹æˆä½ çš„ Google Apps Script Web App URL

let loginCode='', userRole='', approverName='', statusFilter='æœªç°½æ ¸';
let currentKey=null, currentLevel=null;

loginBox.style.display='block';
mainCard.style.display='none';

async function login(){
  const code = document.getElementById('loginCode').value.trim();
  if(!code) return alert('è«‹è¼¸å…¥ä»£ç¢¼');

  const res = await fetch(`${WEB_APP_URL}?action=checkLogin&code=${code}`).then(r=>r.json());
  if(!res) return alert('ä»£ç¢¼ç„¡æ•ˆ');

  loginCode = code;
  userRole = res.role;
  approverName = res.approverName;
  loginBox.style.display='none';
  mainCard.style.display='block';
  setStatus('æœªç°½æ ¸');
}

function logout(){
  loginCode=''; 
  userRole=''; 
  approverName=''; 
  statusFilter='æœªç°½æ ¸';

  loginBox.style.display='block';
  mainCard.style.display='none';
  document.getElementById('tbody').innerHTML='';

  // ğŸ‘‡ å°å‘æŒ‡å®šç¶²é 
  window.location.href = 'https://script.google.com/macros/s/AKfycbxhjvUDaQoTObDb4PUDv5v-JcH_6FjlFsiLsLznlVcCkYYqISAR7qZSIIRG2Y5qlDMX/exec';
}

function setStatus(s){
  statusFilter=s;
  document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
  if(s==='ALL') btnAll.classList.add('active');
  if(s==='æœªç°½æ ¸') btnPending.classList.add('active');
  if(s==='ç°½æ ¸ä¸­') btnProcessing.classList.add('active');
  if(s==='å·²ç°½æ ¸') btnDone.classList.add('active');
  const btn=document.querySelector(`.filters button.active`);
  btn.scrollIntoView({behavior:'smooth', inline:'center'});
  loadData();
}

async function loadData(){
  const res = await fetch(`${WEB_APP_URL}?action=getLeaveData&code=${loginCode}`).then(r=>r.json());
  btnAll.textContent=`å…¨éƒ¨ (${res.count.ALL})`;
  btnPending.textContent=`æœªç°½æ ¸ (${res.count['æœªç°½æ ¸']})`;
  btnProcessing.textContent=`ç°½æ ¸ä¸­ (${res.count['ç°½æ ¸ä¸­']})`;
  btnDone.textContent=`å·²ç°½æ ¸ (${res.count['å·²ç°½æ ¸']})`;
  loadListOnly(res.list);
}

function loadListOnly(list){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML='';
  list.filter(r=>statusFilter==='ALL'||r.status===statusFilter).forEach(r=>{
    const tr = document.createElement('tr');
    const badge = `<span class="badge ${r.colorClass}" onclick="setStatus('${r.status}')">${r.status}</span>`;
    tr.innerHTML=`
      <td>${r.applyDate}</td>
      <td>${r.userName}</td>
      <td>${r.leaveType}</td>
      <td>${r.startDate} ${r.startTime}</td>
      <td>${r.endDate} ${r.endTime}</td>
      <td>${r.hours}</td>
      <td>${badge}</td>
    `;
    // ç£å°/ç¸½ç£å°åˆ†ç´šæ ¸å‡†
    if((userRole==='ç£å°' && !r.approval1) || (userRole==='ç¸½ç£å°' && r.approval1 && !r.approval2)){
      tr.style.cursor='pointer';
      tr.onclick=()=>openModal(r);
    }
    tbody.appendChild(tr);
  });
}

function openModal(r){
  currentKey=r.keyId;
  currentLevel=(r.approval1 && userRole==='ç¸½ç£å°')?2:1;
  modalName.textContent=r.userName;
  modalType.textContent=r.leaveType;
  modalStart.textContent=r.startDate+' '+r.startTime;
  modalEnd.textContent=r.endDate+' '+r.endTime;
  modalHours.textContent=r.hours;
  modalReason.textContent=r.reason||'';
  overlay.style.display=modal.style.display='block';
}

function closeModal(){
  overlay.style.display=modal.style.display='none';
}

async function submit(ok){
  const params = new URLSearchParams();
  params.append('action','updateLeaveApproval');
  params.append('keyId',currentKey);
  params.append('level',currentLevel);
  params.append('approver',approverName);
  params.append('status',ok?'æ ¸å‡†':'ä¸å‡†');

  const res = await fetch(`${WEB_APP_URL}?${params.toString()}`).then(r=>r.json());
  alert(res.message || 'ç°½æ ¸å®Œæˆ');
  closeModal();
  loadData();
}
</script>
</body>
</html>
